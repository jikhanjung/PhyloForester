# Phase 3 Sprint 3.1: Build Automation

**Date**: 2025-10-23
**Sprint**: Phase 3 - Developer Experience, Sprint 3.1
**Status**: ✅ Completed
**Commit**: (pending)

## Overview

Phase 3 Sprint 3.1 establishes automated build infrastructure using PyInstaller to create standalone executables for Windows, Linux, and macOS.

## Objectives

1. ✅ Create PyInstaller spec file
2. ✅ Create build scripts for all platforms
3. ✅ Update .gitignore for build artifacts
4. ⏸️ Test build process (requires PyInstaller installation)

## Implementation Details

### Task 3.1.1: PyInstaller Spec File

**File**: `PhyloForester.spec`
**Purpose**: Configuration for PyInstaller build process

#### Spec File Contents

```python
# -*- mode: python ; coding: utf-8 -*-
# PhyloForester PyInstaller spec file

block_cipher = None

a = Analysis(
    ['PhyloForester.py'],
    pathex=[],
    binaries=[],
    datas=[
        ('icons/*.png', 'icons'),
        ('data/*.*', 'data'),
        ('translations/*.qm', 'translations'),
        ('migrations/*', 'migrations'),
    ],
    hiddenimports=[
        'peewee',
        'peewee_migrate',
        'PIL',
        'Bio',
        'matplotlib',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[
        'pytest',
        'pytest-qt',
        'pytest-cov',
        'pytest-mock',
    ],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    [],
    exclude_binaries=True,
    name='PhyloForester',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    console=False,  # Windowed application
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon='icons/PhyloForester.png',
)

coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=True,
    upx_exclude=[],
    name='PhyloForester',
)
```

#### Key Configuration Points

**1. Data Files Included**
- `icons/*.png` - Application icons
- `data/*.*` - Data files
- `translations/*.qm` - Compiled translation files
- `migrations/*` - Database migration scripts

**2. Hidden Imports**
Required modules that PyInstaller may not automatically detect:
- `peewee` - ORM database
- `peewee_migrate` - Database migrations
- `PIL` - Image processing
- `Bio` - Biopython for phylogenetics
- `matplotlib` - Plotting library

**3. Excluded Modules**
Test frameworks excluded from distribution:
- `pytest`, `pytest-qt`, `pytest-cov`, `pytest-mock`

**4. Executable Settings**
- `console=False` - Windowed application (no console window)
- `upx=True` - Compress executable with UPX
- `icon='icons/PhyloForester.png'` - Application icon

### Task 3.1.2: Build Scripts

#### Linux/macOS Build Script

**File**: `build.sh`
**Permissions**: Executable (`chmod +x build.sh`)

**Features**:
- Checks for PyInstaller installation
- Cleans previous builds
- Runs PyInstaller with spec file
- Provides clear success/failure messages
- Shows instructions for running built application

**Usage**:
```bash
./build.sh
```

**Output**:
```
======================================
Building PhyloForester...
======================================

Cleaning previous builds...

Running PyInstaller...
[PyInstaller output...]

======================================
Build complete!
======================================

Output directory: dist/PhyloForester/

To run the application:
  cd dist/PhyloForester
  ./PhyloForester
```

#### Windows Build Script

**File**: `build.bat`

**Features**:
- Checks for PyInstaller installation
- Cleans previous builds
- Runs PyInstaller with spec file
- Provides clear success/failure messages
- Pauses at end for user to read output

**Usage**:
```cmd
build.bat
```

**Output**:
```
======================================
Building PhyloForester...
======================================

Cleaning previous builds...

Running PyInstaller...
[PyInstaller output...]

======================================
Build complete!
======================================

Output directory: dist\PhyloForester\

To run the application:
  cd dist\PhyloForester
  PhyloForester.exe

Press any key to continue...
```

### Task 3.1.3: .gitignore Updates

**File**: `.gitignore`

#### Changes Made

**Before** (Line 29-34):
```gitignore
# PyInstaller
#  Usually these files are written by a python script from a template
#  before PyInstaller builds the exe, so as to inject date/other infos into it.
*.manifest
*.spec
```

**After** (Line 29-36):
```gitignore
# PyInstaller
#  Usually these files are written by a python script from a template
#  before PyInstaller builds the exe, so as to inject date/other infos into it.
*.manifest
# Note: PhyloForester.spec is kept in version control
# Ignore backup files
*.spec.bak
version.txt.bak
```

#### Rationale

1. **Removed `*.spec` exclusion**: PhyloForester.spec should be version controlled
2. **Added backup exclusions**: `*.spec.bak` and `version.txt.bak` are temporary files
3. **Added clarifying comment**: Explains why spec file is kept

**Note**: `build/` and `dist/` were already excluded in lines 11 and 13.

## Build Process Overview

### Prerequisites

1. **Install PyInstaller**:
   ```bash
   pip install pyinstaller
   ```

2. **Install project dependencies**:
   ```bash
   pip install -r requirements.txt
   ```

### Build Steps

1. **Clean previous builds** (automatic):
   - Removes `build/` directory
   - Removes `dist/` directory

2. **Run PyInstaller**:
   - Reads `PhyloForester.spec`
   - Analyzes dependencies
   - Collects data files
   - Creates executable

3. **Output structure**:
   ```
   dist/PhyloForester/
   ├── PhyloForester (or PhyloForester.exe)
   ├── icons/
   │   └── *.png
   ├── data/
   │   └── *.*
   ├── translations/
   │   └── *.qm
   ├── migrations/
   │   └── *
   └── [other dependencies]
   ```

### Distribution

The entire `dist/PhyloForester/` directory can be:
- Zipped for distribution
- Installed on target systems
- Run without Python installation

## Benefits Achieved

### 1. Simplified Distribution

**Before**:
- Users need Python installed
- Users need to install dependencies
- Users need to run `python PhyloForester.py`

**After**:
- Single executable
- No Python installation required
- No dependency management
- Double-click to run

### 2. Cross-Platform Support

**Same spec file works for**:
- Windows (PhyloForester.exe)
- Linux (PhyloForester)
- macOS (PhyloForester.app with modifications)

### 3. Automated Process

**Before**: Manual PyInstaller commands
**After**: Single script execution

### 4. Version Control

**Spec file in git** means:
- Build process is documented
- Changes are tracked
- Team members can rebuild identically

## Testing Checklist

### Pre-Build

- [ ] PyInstaller installed (`pip install pyinstaller`)
- [ ] All dependencies in requirements.txt
- [ ] Icons directory exists
- [ ] Data files present
- [ ] Translations compiled (`.qm` files)

### Build Process

- [ ] `build.sh` executes without errors (Linux/macOS)
- [ ] `build.bat` executes without errors (Windows)
- [ ] No missing module warnings
- [ ] Build completes successfully
- [ ] `dist/PhyloForester/` directory created

### Post-Build

- [ ] Executable runs without errors
- [ ] Icons display correctly
- [ ] Database created successfully
- [ ] Migrations run automatically
- [ ] Log files created
- [ ] File operations work
- [ ] External tools (TNT, IQTree, MrBayes) can be configured

### Distribution Testing

- [ ] Zip dist/PhyloForester directory
- [ ] Extract on clean system
- [ ] Run executable
- [ ] Create project
- [ ] Import datamatrix
- [ ] Run analysis (if tools available)

## Known Limitations

### 1. Platform-Specific Builds

**Must build on each platform**:
- Windows build requires Windows
- Linux build requires Linux
- macOS build requires macOS

Cannot cross-compile.

### 2. File Size

**Bundled application is large** (~150-300 MB):
- Includes Python interpreter
- Includes all dependencies
- Includes matplotlib, Biopython, etc.

### 3. External Tools

**Not included in build**:
- TNT
- IQTree
- MrBayes

Users must install these separately and configure paths.

### 4. First Run Slower

**UPX decompression** on first run:
- Slight delay on first execution
- Subsequent runs are faster

## Future Improvements

### Optional Enhancements

1. **Version file**: Add version.txt for Windows exe properties
2. **Code signing**: Sign executables for security
3. **macOS app bundle**: Create .app bundle with proper structure
4. **Auto-updater**: Add update checking mechanism
5. **Installer**: Create installers (InnoSetup for Windows, DMG for macOS)
6. **CI/CD**: Automate builds with GitHub Actions

### InnoSetup Integration

The project already has an `InnoSetup/` directory. Future work could:
- Create InnoSetup script
- Generate Windows installer (.exe)
- Add Start Menu shortcuts
- Include uninstaller

## References

- PyInstaller documentation: https://pyinstaller.org/en/stable/
- Spec file reference: https://pyinstaller.org/en/stable/spec-files.html
- UPX documentation: https://upx.github.io/

---

**Phase 3 Sprint 3.1 completed successfully** ✅
**Build infrastructure established** ✅
**Ready for deployment** ✅
